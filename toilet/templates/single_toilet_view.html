
{% extends "standard.html" %}
{% block endhead %}

<script>
  $(document).ready(function(){
  var toilet_id = {{ t.pk }};
  var template = Handlebars.compile($('#review-template').html());

  //Loads or reloads the reviews from the server
  window.loadReviews = function(){
    tapi({noun: "review", verb: "retrieve", data: {toilet_id: toilet_id, start : 0, end : 10},
      callback: function(d){
        $('#reviews').html('');
        $('.num_reviews').html(d.count+' Reviews');
        $('#review-rating').html(generateStars(d.total));

        var data = d.review_set; 
        console.log(data);
        var topReview = {rank: 0, content: ''};
        for(o in data){
          if(topReview.rank < data[o].fields.rank){
            topReview = data[o].fields;
          }
          console.log(data[o]);
          data[o].fields.stars = generateStars(data[o].fields.rank);
          data[o].fields.date = data[o].fields.date.slice(0, 10);
          data[o].fields.pk = data[o].pk;
          $('#reviews').append(template(data[o].fields));
        }
        $('#review-top-comment').html('"' + topReview.content.slice(0, 50) +'..."');		     
        bind_vote_buttons();
     }});
  }
  loadReviews();
  window.tempfunction = loadReviews
  tapi_auto_form('rate-bathroom-form', 
    {  noun: "review"
     , verb: "create"
     , callback :function(data){
          $('#leaveReview').slideUp();
          loadReviews();
    }});
    
  });
  
function bind_vote_buttons () {
    var in_progress = false;
    
    function vote(clicked_node, current_vote){
        if(in_progress === true){ return; }
        in_progress = true;
        var i = parseInt(clicked_node.parents('.review').find('.review_up_down_rank').html());
        clicked_node.parents('.review').find('.review_up_down_rank').html(i + current_vote);
        var str = "up";
        if(current_vote === -1){ str = "down"; }
        tapi({noun:"review", verb:str+"vote", data:{review_pk: clicked_node.attr("data-pk")}
              , callback: function(){ loadReviews(); in_progress = false; }}); 
        return false;
    }
    $('.upvote_button').click(function (e){
        e.preventDefault();
        vote($(this), 1);
    });
    $('.downvote_button').click(function (e){
        e.preventDefault(); 
        vote($(this), -1);
    });
}
</script>

{% endblock %}

{% block content %}



<div class='container'>
<h1>{{ t.name }}</h1>




<div class='col-md-1 col-sm-2 col-xs-3'>
  <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIwAAACMCAYAAACuwEE+AAAEnElEQVR4Xu3X2ytscRyG8e+UcqOQU0IKF1JIyA1X/nBu5JRISDmXksipnE+736rRGIpnz96m0TO122XeaU3P+rTWmtzZ2dlr+LLANwvkBPPNUs6yAoIRAiogGJTLsWA0gAoIBuVyLBgNoAKCQbkcC0YDqIBgUC7HgtEAKiAYlMuxYDSACggG5XIsGA2gAoJBuRwLRgOogGBQLseC0QAqIBiUy7FgNIAKCAblciwYDaACgkG5HAtGA6iAYFAux4LRACogGJTLsWA0gAoIBuVyLBgNoAKCQbkcC0YDqIBgUC7HgtEAKiAYlMuxYDSACggG5XIsGA2gAoJBuRwLRgOogGBQLseC0QAqIBiUy7FgNIAKCAblciwYDaACgkG5HAtGA6iAYFAux4LRACogGJTLsWA0gAoIBuVyLBgNoAKCQbkcC0YDqIBgUC7HgtEAKiAYlMuxYDSACggG5XIsGA2gAoJBuRwLRgOogGBQLscVD+bx8THm5uaitrY2BgYGPpzR/f392N7ejqGhoWhoaMjePzk5ia2trbi/v8/+1tfXF1VVVd/S8NPH+9aX+sFRRYM5Pz+Pzc3NuL6+jubm5g9gLi4uYmlpKV5fX9/AJCQzMzNRV1cXLS0t2efb2tqit7f3y+w/fbwvv1AZBhUL5unpKaanp6O1tTWOj4+jsbHxHZiHh4eYn5+P6urquLq6egNzdHQU6+vrMTg4GE1NTbG4uBh3d3cxMTERe3t7sbOzE93d3dHR0RGzs7ORy+VibGws+/9fH68M57vkQ1YsmJeXl7i5uYmampqYmprKbi2Ft6Tl5eVIqDo7O2N1dfUNTB7FyMhIdpVZWVmJ09PTmJyczGKmz6UrU3ovXVHSLt3u/sfxEsJKe1UsmMLQxWAODg5id3c3hoeHM1Rra2vR39+fXVHSe+kq8hmYdALTLStdmdIVqqurK/tX/PqXxxNMGQoUn8B0m7m8vPzwTRKa5+fn2NjYeHdLSkjGx8ezfXoeWlhYyHYJWLp1fQWmlOOVIVdJh/yVV5iEJd2O0is9v6QrSk9PT/a8kx6A00NvfX39h4fehCSd/HR1SQ/Rh4eH2cNwe3v7u8jFQP/2eCWduTJ9+FeCKWyZnk/Sc0rxz+r0Uzs97Bb+rE6/mBKS/O0rXWlub29jdHQ0e1bKvz57Zsq/R45XpnNe0mF/BZiSCvhhVEAwKJdjwWgAFRAMyuVYMBpABQSDcjkWjAZQAcGgXI4FowFUQDAol2PBaAAVEAzK5VgwGkAFBINyORaMBlABwaBcjgWjAVRAMCiXY8FoABUQDMrlWDAaQAUEg3I5FowGUAHBoFyOBaMBVEAwKJdjwWgAFRAMyuVYMBpABQSDcjkWjAZQAcGgXI4FowFUQDAol2PBaAAVEAzK5VgwGkAFBINyORaMBlABwaBcjgWjAVRAMCiXY8FoABUQDMrlWDAaQAUEg3I5FowGUAHBoFyOBaMBVEAwKJdjwWgAFRAMyuVYMBpABQSDcjkWjAZQAcGgXI4FowFUQDAol2PBaAAVEAzK5VgwGkAFBINyORaMBlABwaBcjgWjAVRAMCiX4z8rrNemOx9CfwAAAABJRU5ErkJggg==" class="img-responsive img-rounded foobar">

<!-- -->
  <!--<span class='icon-stack icon-3x visible-lg'>
    <i class="icon-sign-blank icon-stack-base"></i>
    <i class="icon-leaf icon-light"></i>
  </span>

  <span class='icon-stack icon-2x visible-s'>
    <i class="icon-sign-blank icon-stack-base"></i>
    <i class="icon-leaf icon-light"></i>
  </span>
  -->
</div>
<div class='col-md-11 col-sm-10 col-xs-9'>
  <div class='row'>
    <div id="review-rating" class='col-md-4 col-sm-4 col-xs-12 star-ratings' >
    </div>
    <div class='col-md-2 col-sm-3 col-xs-12 num_reviews'></div>
    <div class='col-md-2 visible-lg visible-md visible-sm'><span class='icon-camera-retro' style='margin-right: 5px'></span>4 photos</div>
  </div><!--row-->
  <div class='row'>
    <div class='col-md-6 col-sm-7 col-xs-12'>
    </div>
    <div class='col-md-2 col-sm-3 col-xs-4'>
      <span class='badge'><span class='icon-map-marker' style='margin-right: 5px;'></span>1.2 miles</span>
    </div>
  </div><!-- row -->
  <div class='row'>
    <div class='col-md-12 col-sm-12 col-xs-12 visible-lg visible-md visible-sm'>
      <p id='review-top-comment'></p>
    </div>
    </div> <!-- row -->
</div>

<div class='clearfix visible-xs'></div>

{% if has_reviewed == False and user.is_authenticated %}

  <div id='leaveReview' class='col-lg-offset-1 col-lg-7 col-md-8 col-sm-10 col-xs-12 row'>
    <link rel='stylesheet' href='/static/css/rateit.css'>
    <script src='/static/js/jquery.rateit.min.js'></script>
    <div class="panel panel-default">
      <a class="panel-heading panel-button">Review This Bathroom
	<span class='panel-button-icon icon-chevron-down'></span>
      </a>
      <div class="panel-body" id="reviewForm" style='display: none;'>
	<form id="rate-bathroom-form" class="form-horizontal" role="form" 
              data-validate="parsley">
          <input type="hidden" name="toilet" value="{{ t.pk }}" />
	  <div class="form-group">
	    <label for="inputRating" class="col-lg-2 col-sm-2 control-label">Rating</label>
	    <div class="col-lg-10 col-sm-10">
              
	      <input name="rank" type="range" value="3" step="1" 
                     id="inputRating" data-required="true">
	      <div class="rateit" data-rateit-backingfld="#inputRating" data-rateit-resetable="false"  data-rateit-ispreset="true"
		   data-rateit-min="0" data-rateit-max="5">
	      </div>
	    </div>
	  </div><!-- form-group -->
	  <div class="form-group">
	    <label for="inputReview" class="col-lg-2 col-sm-2 control-label">Review</label>
	    <div class="col-lg-5 col-sm-7">
	      <textarea id="inputReview" name="content" class="form-control" rows="3" data-required="true" data-minlength="20" data-validation-minlength="1" ></textarea>
	    </div>
	  </div><!-- form-group -->

	  <div class="form-group">
	    <div class="col-lg-offset-2 col-lg-10">
	      <button type="submit" class="col-lg-4 col-xs-12 col-sm-4 btn btn-default">Submit Review</button>
	    </div>
	  </div>
	</form>
      </div><!-- panel-body -->
    </div> <!-- panel -->
  </div> <!-- #leaveReview -->

  {% endif %}
  <div class='clearfix '></div>





<script id="review-template" type="text/x-handlebars-template">
  <div class='review col-lg-8 col-md-8 col-sm-10 col-xs-12'>
    <div style='clear: both; overflow: hidden;'>
      <div class='col-xs-2 col-sm-1 col-md-1'>
	<div style='text-align: center;'><a href='' style='color:#aaaaaa; display: block;' class='icon-arrow-up upvote_button' data-pk='{% templatetag openvariable %}pk{% templatetag closevariable %}'></a></div>
	<div style='text-align: center; font-weight: bold; color: #aaaaaa;' class='review_up_down_rank'>
	  {% templatetag openvariable %}up_down_rank{% templatetag closevariable %}</div>
	<div style='text-align: center;'><a href='' style='color:#aaaaaa; display: block;' class='icon-arrow-down downvote_button' data-pk='{% templatetag openvariable %}pk{% templatetag closevariable %}'></a></div>
      </div>
      <div class='col-xs-2 col-sm-1 col-md-1' style='margin-left: 0px;'>
	<div style='text-align: center;'><span class='icon-user icon-3x'></span></div>
	<div style='text-align: center;'><small>
	    {% templatetag openvariable %}username{% templatetag closevariable %}</small></div>
      </div>
      <div class='col-md-10 col-sm-9 col-xs-8'>
	<div class='row'>
	  <div class='col-lg-4 col-md-3 col-sm-4 star-ratings' style='text-align: left;' >
	    {% templatetag openvariable %}{ stars }{% templatetag closevariable %}
	  </div>
	  <div class='col-lg-4 col-md-3 col-sm-3'>
	    {% templatetag openvariable %} date {% templatetag closevariable %}
	  </div>
	  <div class='col-lg-4 col-md-3 col-sm-3'><span class='icon-camera-retro' style='margin-right: 5px'></span>4 photos </div>

	</div>
      </div>
	<div class='col-md-10 col-sm-9 col-xs-12'>
	  <p class='review_content'></p>
	  {% templatetag openvariable %} content {% templatetag closevariable %}
	</div>
      </div>

  </div>
</script>




<h2> Reviews </h2>
<div id='reviews'></div>


</div>


{% endblock %}
